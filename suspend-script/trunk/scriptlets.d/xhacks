# -*- sh -*-
# vim:ft=sh:ts=8:sw=4:noet

AddConfigHandler XHacksOptions
AddConfigHelp "LeaveXBeforeSuspend <boolean>" "If your X driver is unable to resume properly, you can try switching to a text console first by setting this to yes."
AddConfigHelp "nVidiaHack <boolean>" "Some X drivers can be reinitialised by launching a fake X server after resuming to restore the state of the graphics card. Set this to yes to do so."

XHacksSuspend() {
    if [ x"$XHACK_LEAVE_X" = "x1" ] ; then
	which fgconsole > /dev/null 2>&1 && XHACK_ORIGINAL_VT=`fgconsole` || XHACK_ORIGINAL_VT=1
	[ -z "$SWSUSPVT" ] && DEST_VT=15 || DEST_VT="$SWSUSPVT"
	chvt $DEST_VT
    fi
}

XHacksResume() {
    if [ x"$XHACK_NVIDIA" = "x1" ] ; then
	# Launch a fake X server to reinitialise the graphics card
	vecho 1 "Launching fake X server."
	export XAUTHORITY="/tmp/.Xauthority-swsusp-fake-x-server"
	export HOME=/dev/shm
	xauth <<EOT
add :3 . 00
generate :3.0 .
EOT
	xinit /bin/false -- :3
    fi

    [ -n "$XHACK_ORIGINAL_VT" ] && chvt $XHACK_ORIGINAL_VT
}

XHacksOptions() {
    case $1 in
	leavexbeforesuspend)
	    BoolIsOn "$1" "$2" && XHACK_LEAVE_X=1 || return 0
	    # only break from case statement if we need something done
	    ;;
	nvidiahack)
	    BoolIsOn "$1" "$2" && XHACK_NVIDIA=1 || return 0
	    # only break from case statement if we need something done
	    ;;
	*)
	    return 1
    esac
    if [ -z "$XHACKS_HOOKED" ] ; then
	AddSuspendHook 11 XHacksSuspend
	AddResumeHook 11 XHacksResume
	XHACKS_HOOKED=1
    fi
    return 0
}

# $Id$

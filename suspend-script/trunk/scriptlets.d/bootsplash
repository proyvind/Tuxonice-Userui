# -*- sh -*-
# vim:ft=sh:ts=8:sw=4:noet

AddConfigHandler SplashOptions
AddConfigHelp "Bootsplash <boolean>" "Showing progress on an bootsplash enabled kernel :)"
AddConfigHelp "BootsplashConfig <configfile>" "Bootsplash config file (default is /etc/bootsplash/default/config/bootsplash-1024x768.cfg)"


# default bootsplash theme config file
SPLASH_CONFIG_FILE="/etc/bootsplash/default/config/bootsplash-1024x768.cfg"

SplashProgress() 
{
    if [ x"$USE_BOOTSPLASH" = "x1" ] ; then
	CURRENT_PROGRESS=$((65535*${SPLASH_PROGRESS}/100));
	echo "show $CURRENT_PROGRESS" > /proc/splash
	SPLASH_PROGRESS=$(($SPLASH_PROGRESS+10));
    fi
}

SplashStart() {
    if [ x"$USE_BOOTSPLASH" = "x1" ] ; then
	# check if /proc/splash and /sbin/splash exists 
	if [ ! -f /proc/splash ]; then
	    USE_BOOTSPLASH=0
	    vecho 1 "/proc/splash not found. Bootsplash disabled."
	    return 0
	fi
	if [ ! -f /sbin/splash ]; then
	    USE_BOOTSPLASH=0
	    vecho 1 "/sbin/splash not found. Bootsplash disabled."
	    return 0
	fi

	# configfile exists ?
	if [ ! -f "$SPLASH_CONFIG_FILE" ]; then
	    USE_BOOTSPLASH=0
	    vecho 1 "config file not found. Bootsplash disabled."
	    return 0
	fi

	# start at ten because something is already done
	SPLASH_PROGRESS=10
	    
	# go
	/sbin/splash -s -u 0 "$SPLASH_CONFIG_FILE"
	echo "silent" > /proc/splash 
	echo "show 0" > /proc/splash

    fi
}

SplashResume() {
    SplashStart
    # XXX add text output
}

SplashSuspend() {
    SplashStart
    # XXX add text output
}

SplashStop() {
    if [ x"$USE_BOOTSPLASH" = "x1" ] ; then
	/sbin/splash -s -u 0 -n "$SPLASH_CONFIG_FILE"
    fi
}

SplashOptions() {
    case $1 in
	bootsplash)
	    BoolIsOn "$1" "$2" && USE_BOOTSPLASH=1 || return 0
	    # don't return still to do
	    ;;
	bootsplashconfig)
	    SPLASH_CONFIG_FILE="$2"
	    return 0
	    ;;
	*)
	    return 1
    esac

    if [ -z "$BOOTSPLASH_HOOKED" ] ; then
	# in call order
	AddSuspendHook 12 SplashSuspend
	AddSuspendHook 20 SplashProgress
	AddSuspendHook 30 SplashProgress
	AddSuspendHook 40 SplashProgress
	AddSuspendHook 50 SplashProgress
	AddSuspendHook 60 SplashProgress
	AddSuspendHook 70 SplashProgress
	AddSuspendHook 80 SplashProgress
	AddSuspendHook 90 SplashProgress
	AddSuspendHook 98 SplashProgress
	AddResumeHook 98 SplashResume
	AddResumeHook 90 SplashProgress
	AddResumeHook 80 SplashProgress
	AddResumeHook 70 SplashProgress
	AddResumeHook 60 SplashProgress
	AddResumeHook 50 SplashProgress
	AddResumeHook 40 SplashProgress
	AddResumeHook 30 SplashProgress
	AddResumeHook 20 SplashProgress
	AddResumeHook 12 SplashStop
	BOOTSPLASH_HOOKED=1
    fi

    return 0
}

# $Id$
